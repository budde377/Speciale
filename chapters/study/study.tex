The possibilities of the PHP array data structure allows for many different kinds of use ranging from lists over maps to trees and tables. The purpose of the dynamic analysis in this chapter is to detect patterns of array-usage in order to be able to identify a few more restrictive data types contained within the way PHP arrays are used. The results of the analysis are used to choose suitable abstraction for the static analysis in chapter \ref{ch:analysis}. The first section of this chapter describes basic definitions used in the dynamic analysis to detect patterns. With the definitions in place a hypothesis for the analysis is formed in section \ref{sec:dynhypothesis} followed by a discussion of implementation details in section \ref{sec:studyImplementation}. Section \ref{sec:analysisResults} presents the results of the dynamic analysis and section \ref{sec:studyConclusion} draws the conclusion of the analysis.

\begin{definition}
Let $a$ be an array containing values of the same type, where all integer keys from 0 to $count(a)-1$ exists. Then $a$ can be considered an array of type list.
\end{definition}

An example of an array used as a list can be seen as figure \ref{lst:list_array}, where an element is appended to the list and shifted off the beginning of the list. The values of the \texttt{\$numbers} array all share the same type, integers, and the keys, though never directly manipulated, are, at initialization, from 0 to 2. The following operations all preserve the type consensus of the values and the type of the keys. 

\begin{program}[ht]
\begin{lstlisting}
$numbers = [1,2,3];
$numbers[] = 4; // $numbers = [1,2,3,4]
$first = array_shift($numbers); // $numbers = [2,3,4]
\end{lstlisting}
\caption{Array used as a list}
\label{lst:list_array}
\end{program}

Besides the \texttt{array\_shift} function and the array append operation, $v[]$, the PHP library contains many other library functions for manipulating lists. E.g. \texttt{array\_push}, \texttt{array\_pop}, \texttt{sort}, etc.

Arrays can also explicitly define keys, which can be either a string or an integer. 

\begin{definition}
Let $a$ be an array containing values of the same type, where all integer keys from 0 to $count(a)-1$ does not exists. Then $a$ can be considered an array of type map.
\end{definition}

As the name suggests, maps can be used as a mapping from a string/integer to a value. In figure \ref{lst:map_array} the \texttt{\$text\_to\_int} array is a mapping from strings containing some numbers to its corresponding integer representation. 

\begin{program}[ht]
\begin{lstlisting}
$text_to_int = 
    [ 
        'one' => 1,
        'two' => 2,
        'three' =>  3
    ];
echo $text_to_int[$input]; 
$keys = array_keys($text_to_int);
    // $keys = ["one", "two", "three"]
$values = array_values($text_to_int);
    // $values = [1,2,3]
\end{lstlisting}
\caption{Array used as a map}
\label{lst:map_array}
\end{program}

If given an map-array, the values or keys can be fetched using the functions \texttt{array\_values} or \texttt{array\_keys} respectively. These functions returns an array of list type. 

Finally arrays can be treated as objects, i.e. the entries can be viewed as properties of arbitrary type. These arrays could be replaced by the \texttt{stdClass} which mainly is used for its dynamic properties, just like arrays. Some of the build in arrays of PHP can be considered objects, this include the \texttt{\$\_SERVER} array\footnote{\url{http://php.net/manual/en/reserved.variables.server.php}}. This array contains server and execution environment information, which are of different types, e.g. \texttt{\$\_SERVER['argv']} is an array of arguments passed to the interpreter, and \texttt{\$\_SERVER['REQUEST\_TIME']} is an integer UNIX timestamp of the start of the request. 

\begin{definition}
Let $a$ be an array containing values of different type. Then $a$ can be considered an array of type object.
\end{definition}


\section{Hypothesis}
\label{sec:dynhypothesis}
Our hypothesis is that any given array throughout its lifespan, from initialization to last usage, can be viewed as one, and only one, of the above mentioned types. I.e. either as a list, a map or an object. It is also expected that the arrays in general are acyclic and that that append, push, pop, shift and unshift operations are only used on arrays of type list.

If the hypothesis holds it should be possible to statically analyse the code to identify these types and detect errors related to misuse of the arrays e.g. using maps as lists or vice versa. The hypothesis is tested against a corpus consisting of ten widely used open source frameworks, by performing a dynamic analysis of the code.

The frameworks chosen all implement some kind of test suite written in PHPUnit\footnote{\url{https://phpunit.de/}}. A unit testing framework for PHP progrms similar to JUnit for Java programs. By running the test suites on a modified PHP interpreter\footnote{https://github.com/Silwing/php-src}, we are able log and later analyze the structure and usage of the arrays. By using test suites instead of manually inspecting the frameworks through e.g. a browser, the aim is to gain a higher code coverage. This follows from the assumption that the developers are using code coverage as a metric of the quality of the test-suite. The corpus consists of the following open source frameworks:

\begin{itemize}
    \item \emph{WordPress}: A blogging system and a content management system\citeB{wordpress}.
    \item \emph{phpMyAdmin}: An administration panel for managing MySQL database\citeB{phpmyadmin}.
    \item \emph{MediaWiki}: The framework for creating wiki sites\citeB{mediawiki}.
    \item \emph{Joomla}: A content management system \citeB{joomla}.
    \item \emph{CodeIgniter}: A lightweight framework for building web applications\citeB{codeigniter}.
    \item \emph{phpBB}: A forum platform\citeB{phpbb}.
    \item \emph{Symfony 2}: A framework used in many major systems, such as phpBB, magento and Drupal\citeB{symfony2}.
    \item \emph{Magento 2}: An e-commerce platform\citeB{magento2}.
    \item \emph{Zend Framework}: A framework for web development focused on simplicity, reusability and performance\citeB{zendframework}.
    \item \emph{Part}: A lightweight content management system developed by one of the authors of this thesis\citeB{part}.
\end{itemize}


\section{Implementation}
\label{sec:studyImplementation}
\input{chapters/study/implementation}


%\section{Feature usage analysis}
%\label{sec:featureAnalysis}
%\input{chapters/study/usage_analysis}

\section{Results}
\label{sec:analysisResults}

\input{chapters/study/analysis_result}


\section{Conclusion}
\label{sec:studyConclusion}
The purpose of the dynamic analysis was to determine whether PHP array usage can be split into semantic categories and if arrays stay in one category during their lifetime. 

The results show that generally arrays keep the same type during their lifetime. Further more the usage of specific array operations proved almost exclusive for lists. This information can be used to define unexpected behavior reported by the static analysis.

A significant amount of arrays turned out to be objects with list-keys by the initial definition. These objects indicates that the object type is not providing significant information in itself, and shows the possibility that the definitions of maps and lists consume the object type; i.e. letting maps and lists allow values of different type.

Almost every framework in the corpus contains some cyclic arrays why the static analysis have to take the possibility of recursive types into consideration. However the small amount of cyclic arrays indicate that an imprecise approach will have a minimal impact on the overall precision.


\begin{comment}
HASHSES

/users/budde377/encasa/tapas-survey/corpus/git/Part
657bc1fed0eafac1acf6d82ce42ec2243d146207
/users/budde377/encasa/tapas-survey/corpus/git/phpmyadmin
d295244b7b9b21dab4c97e6bbcca182e98ce7d67
/users/budde377/encasa/tapas-survey/corpus/git/mediawiki
97c4e93eefc7182fb4a166e752d44e8853fe3218
/users/budde377/encasa/tapas-survey/corpus/git/joomla-cms
27b137e78925aedeebff9bf7d56be6b5ba080a4a
/users/budde377/encasa/tapas-survey/corpus/git/CodeIgniter
64d1d82e03ace010dcf03c509cf6b87e0da27ff4
/users/budde377/encasa/tapas-survey/corpus/git/phpbb
e132e9ba76e63f71a6019b79c7a42417b3b633b4
/users/budde377/encasa/tapas-survey/corpus/git/symfony
e91058089c900071362270f0756b166bf4028edc
/users/budde377/encasa/tapas-survey/corpus/git/magento2
d0131d777e173f60c2f6acd435173b5c7bb513c5
/users/budde377/encasa/tapas-survey/corpus/git/zf2
97f67e0d06f1693a0b6e9e62561ca482adc85f7c


SVN Stuff (Wordpress)

[budde377@casa01 trunk] (master) \$ svn info
Path: .
Working Copy Root Path: /encasa/budde377/tapas-survey/corpus/svn/trunk
URL: https://develop.svn.wordpress.org/trunk
Relative URL: ^/trunk
Repository Root: https://develop.svn.wordpress.org
Repository UUID: 602fd350-edb4-49c9-b593-d223f7449a82
Revision: 31753
Node Kind: directory
Schedule: normal
Last Changed Author: SergeyBiryukov
Last Changed Rev: 31753
Last Changed Date: 2015-03-12 15:56:34 +0100 (Thu, 12 Mar 2015)



\end{comment}